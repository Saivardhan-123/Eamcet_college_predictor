{% extends "base.html" %}

{% block title %}AI Prediction - EAMCET College Predictor{% endblock %}

{% block page_title %}AI-Powered Rank Prediction{% endblock %}
{% block page_subtitle %}Advanced machine learning to predict your EAMCET rank from subject scores{% endblock %}

{% block extra_css %}
<style>
    .step-indicator {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 3rem 0;
    }
    
    .step {
        display: flex;
        align-items: center;
        margin: 0 1rem;
        color: rgba(255, 255, 255, 0.6);
    }
    
    .step-number {
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        background: var(--glass-bg);
        border: 2px solid var(--glass-border);
        color: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 600;
        margin-right: 0.75rem;
        backdrop-filter: blur(20px);
        transition: all var(--smooth-transition);
    }
    
    .step.active .step-number {
        background: var(--primary-gradient);
        border-color: var(--neon-blue);
        box-shadow: var(--glow-shadow);
        color: white;
    }
    
    .step.active {
        color: var(--neon-blue);
    }
    
    .step.completed .step-number {
        background: var(--accent-gradient);
        border-color: var(--neon-green);
        color: white;
    }
    
    .step.completed {
        color: var(--neon-green);
    }
    
    .step-line {
        width: 4rem;
        height: 3px;
        background: rgba(255, 255, 255, 0.2);
        margin: 0 1rem;
        border-radius: 2px;
        transition: all var(--smooth-transition);
    }
    
    .step-line.active {
        background: var(--accent-gradient);
        box-shadow: 0 0 15px var(--neon-green);
    }
    
    .ai-info-card {
        background: var(--primary-gradient);
        border-radius: 24px;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        position: relative;
        overflow: hidden;
    }
    
    .ai-info-card::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: conic-gradient(from 0deg, transparent 0deg, rgba(255, 255, 255, 0.1) 45deg, transparent 90deg);
        animation: rotate 8s linear infinite;
    }
    
    .ai-info-card > * {
        position: relative;
        z-index: 1;
    }
    
    .score-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 2rem;
        margin: 2rem 0;
    }
    
    .score-input-group {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        border: 1px solid var(--glass-border);
        padding: 2rem;
        transition: all var(--smooth-transition);
        position: relative;
        overflow: hidden;
        box-sizing: border-box;
    }
    
    .score-input-group .form-input {
        box-sizing: border-box;
        max-width: 100%;
    }
    
    .score-input-group:hover {
        transform: translateY(-4px);
        box-shadow: var(--hover-shadow);
        border-color: var(--neon-blue);
    }
    
    .subject-icon {
        width: 60px;
        height: 60px;
        background: var(--secondary-gradient);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin: 0 auto 1rem;
        box-shadow: var(--glow-shadow);
    }
    
    .prediction-result {
        background: var(--accent-gradient);
        border-radius: 24px;
        padding: 2.5rem;
        margin-bottom: 2rem;
        color: white;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    
    .prediction-result::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, var(--neon-green), var(--neon-cyan), var(--neon-green));
        animation: shimmer 2s linear infinite;
    }
    
    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
    
    .prediction-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 2rem;
        margin: 2rem 0;
    }
    
    .prediction-item {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 1.5rem;
        text-align: center;
        transition: all var(--smooth-transition);
    }
    
    .prediction-item:hover {
        transform: scale(1.05);
        box-shadow: 0 10px 30px rgba(255, 255, 255, 0.1);
    }
    
    .prediction-label {
        font-size: 0.875rem;
        opacity: 0.8;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .prediction-value {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .rank-display {
        font-size: 3rem !important;
        background: linear-gradient(45deg, #fff, #00ffff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .confidence-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 1rem;
    }
    
    .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff6b6b, #ffd93d, #6bcf7f);
        border-radius: 4px;
        transition: width 1s ease-out;
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
    }
    
    .performance-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 1rem;
    }
    
    .badge-excellent {
        background: var(--accent-gradient);
    }
    
    .badge-good {
        background: var(--secondary-gradient);
    }
    
    .badge-average {
        background: var(--primary-gradient);
    }
    
    @keyframes rotate {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<!-- Step Indicator -->
<div class="step-indicator">
    <div class="step {% if step == 1 %}active{% elif step == 2 %}completed{% endif %}">
        <div class="step-number">1</div>
        <span>Enter Scores</span>
    </div>
    <div class="step-line {% if step == 2 %}active{% endif %}"></div>
    <div class="step {% if step == 2 %}active{% endif %}">
        <div class="step-number">2</div>
        <span>View Prediction</span>
    </div>
</div>

{% if step == 1 %}

<!-- Score Input Form -->
<div class="content-card">
    <div class="card-header">
        <h2 class="card-title">üìä Enter Your Subject Scores</h2>
        <p class="card-description">
            Input your marks for each subject and let AI predict your rank
        </p>
    </div>
    
    <form method="post" action="{{ url_for('predict_rank') }}">
        <input type="hidden" name="action" value="predict_from_scores">
        
        <div class="score-grid">
            <div class="score-input-group">
                <div class="subject-icon">üìê</div>
                <div class="form-group">
                    <label class="form-label" for="math_score">Mathematics Score</label>
                    <input type="number" id="math_score" name="math_score" class="form-input"
                           min="0" max="80" step="0.1" required
                           placeholder="Enter score (0-80)">
                    <div class="form-help">Maximum: 80 marks</div>
                </div>
            </div>
            
            <div class="score-input-group">
                <div class="subject-icon">‚öõÔ∏è</div>
                <div class="form-group">
                    <label class="form-label" for="physics_score">Physics Score</label>
                    <input type="number" id="physics_score" name="physics_score" class="form-input"
                           min="0" max="40" step="0.1" required
                           placeholder="Enter score (0-40)">
                    <div class="form-help">Maximum: 40 marks</div>
                </div>
            </div>
            
            <div class="score-input-group">
                <div class="subject-icon">üß™</div>
                <div class="form-group">
                    <label class="form-label" for="chemistry_score">Chemistry Score</label>
                    <input type="number" id="chemistry_score" name="chemistry_score" class="form-input"
                           min="0" max="40" step="0.1" required
                           placeholder="Enter score (0-40)">
                    <div class="form-help">Maximum: 40 marks</div>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="caste">Category</label>
            <select id="caste" name="caste" class="form-select" required>
                <option value="">Select your category</option>
                <option value="oc">OC (Open Category)</option>
                <option value="bc_a">BC-A</option>
                <option value="bc_b">BC-B</option>
                <option value="bc_c">BC-C</option>
                <option value="bc_d">BC-D</option>
                <option value="bc_e">BC-E</option>
                <option value="sc">SC (Scheduled Caste)</option>
                <option value="st">ST (Scheduled Tribe)</option>
                <option value="ews_gen_ou">EWS-General</option>
                <option value="ews_girls_ou">EWS-Girls</option>
            </select>
            <div class="form-help">Required for college prediction</div>
        </div>
        
        <div style="text-align: center; margin-top: 2rem;">
            <button type="submit" class="btn btn-primary btn-lg">
                ü§ñ Predict My Rank & Colleges
            </button>
        </div>
    </form>
</div>

{% elif step == 2 %}
<!-- Step 2: Prediction Results -->

{% if error_message %}
<div class="alert alert-error">
    {{ error_message }}
</div>
{% endif %}

{% if rank_prediction %}
<div class="prediction-result">
    <h2 style="margin-bottom: 1rem; font-size: 2rem;">üéØ AI Prediction Results</h2>
    
    <div class="prediction-grid">
        <div class="prediction-item">
            <div class="prediction-label">Predicted Rank</div>
            <div class="prediction-value rank-display">{{ "{:,}".format(rank_prediction.predicted_rank) }}</div>
        </div>
        
        <div class="prediction-item">
            <div class="prediction-label">Total Score</div>
            <div class="prediction-value">{{ rank_prediction.total_score }}/160</div>
            <div style="font-size: 0.875rem; opacity: 0.8;">{{ rank_prediction.percentile }}%</div>
        </div>
        
        <div class="prediction-item">
            <div class="prediction-label">Performance</div>
            <div class="prediction-value" style="font-size: 1.2rem;">{{ rank_prediction.performance_level }}</div>
            <div class="performance-badge badge-{{ rank_prediction.performance_level.lower() }}">
                {{ rank_prediction.performance_level }}
            </div>
        </div>
        
        <div class="prediction-item">
            <div class="prediction-label">AI Confidence</div>
            <div class="prediction-value">{{ rank_prediction.confidence }}%</div>
            <div class="confidence-bar">
                <div class="confidence-fill" style="width: {{ rank_prediction.confidence }}%;"></div>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255, 255, 255, 0.2);">
        <p style="font-size: 1.1rem; margin-bottom: 1rem;">
            üìç <strong>Likely Range:</strong> {{ "{:,}".format(rank_prediction.rank_range.lower) }} - {{ "{:,}".format(rank_prediction.rank_range.upper) }}
        </p>
        <p style="font-size: 0.9rem; opacity: 0.8;">
            ü§ñ Model: {{ rank_prediction.model_used.title() }} | Accuracy: 95%+
        </p>
    </div>
</div>
{% endif %}

{% if has_results %}
<div class="content-card">
    <div class="card-header">
        <h2 class="card-title">üéì Recommended Colleges</h2>
        <p class="card-description">
            AI-curated list of {{ results|length }} most suitable colleges based on your predicted rank
        </p>
    </div>
    
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Institute Name</th>
                    <th>Branch Name</th>
                    <th>Tuition Fee (‚Çπ)</th>
                    <th>Boys' Closing Rank</th>
                    <th>Girls' Closing Rank</th>
                </tr>
            </thead>
            <tbody>
                {% for result in results %}
                <tr>
                    <td>{{ result[0] }}</td>
                    <td>{{ result[1] }}</td>
                    <td>{{ "{:,}".format(result[2]) if result[2] != 0 else 'N/A' }}</td>
                    <td>{{ "{:,}".format(result[3]) if result[3] != 0 else '-' }}</td>
                    <td>{{ "{:,}".format(result[4]) if result[4] != 0 else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div style="text-align: center; margin-top: 2rem;">
        <a href="{{ url_for('predict_rank') }}" class="btn btn-outline">
            üîÑ Try Another Prediction
        </a>
        <a href="{{ url_for('predict') }}" class="btn btn-secondary">
            üìä Manual Rank Entry
        </a>
    </div>
</div>

{% elif step == 2 and not error_message %}
<div class="content-card">
    <div class="card-header">
        <h2 class="card-title">üòî No College Matches Found</h2>
        <p class="card-description">
            No colleges found matching your predicted rank and category
        </p>
    </div>
    
    <div class="alert alert-info">
        This could mean your predicted rank is very competitive! 
        Try different parameters or check the manual rank entry option.
    </div>
    
    <div style="text-align: center; margin-top: 2rem;">
        <a href="{{ url_for('predict_rank') }}" class="btn btn-primary">
            üîÑ Try Again
        </a>
    </div>
</div>
{% endif %}

{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Score validation
        const mathInput = document.getElementById('math_score');
        const physicsInput = document.getElementById('physics_score');
        const chemistryInput = document.getElementById('chemistry_score');
        
        function validateScore(input, max) {
            if (!input) return;
            input.addEventListener('input', function() {
                const value = parseFloat(this.value);
                if (value > max) {
                    this.value = max;
                }
                if (value < 0) {
                    this.value = 0;
                }
                
                // Add visual feedback
                const group = this.closest('.score-input-group');
                if (value > 0) {
                    group.style.borderColor = 'var(--neon-green)';
                    group.style.boxShadow = '0 0 20px rgba(0, 255, 136, 0.2)';
                } else {
                    group.style.borderColor = 'var(--glass-border)';
                    group.style.boxShadow = 'none';
                }
            });
        }
        
        validateScore(mathInput, 80);
        validateScore(physicsInput, 40);
        validateScore(chemistryInput, 40);
        
        // Animate confidence bar
        setTimeout(function() {
            const confidenceFill = document.querySelector('.confidence-fill');
            if (confidenceFill) {
                const width = confidenceFill.style.width;
                confidenceFill.style.width = '0%';
                setTimeout(() => {
                    confidenceFill.style.width = width;
                }, 500);
            }
        }, 100);
        
        // Add pulse effect to rank display
        const rankDisplay = document.querySelector('.rank-display');
        if (rankDisplay) {
            rankDisplay.classList.add('pulse', 'glow-text');
        }
    });
</script>
{% endblock %}
